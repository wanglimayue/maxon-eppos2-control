#include "sys.h"
#include "delay.h"  
#include "usart.h"   
#include "led.h"
#include "lcd.h"
#include "key.h"  
#include "usmart.h" 
#include "can.h"
//ALIENTEK 探索者STM32F407开发板 实验27
//CAN收发 实验  
//技术支持：www.openedv.com
//广州市星翼电子科技有限公司
    
  s16	currentValue;
	u8 canbuf_C[8];//电流返回数据

		
int main(void)
{  
	u8 canbuf0[]={0x2B,0x01,0x20,0x00,0x00,0x00,0x00,0x00};//设置can比特率为1MHz,默认0可不配置，可以设置800K试一下，0x01
	u8 canbuf1[]={0x2B,0x02,0x64,0x00,0x10,0x00,0x00,0x00};//设置电机类型为EC-sin
	u8 canbuf2[]={0x2B,0x10,0x64,0x01,0xF2,0x03,0x00,0x00};//设置额定电流最大1.01A   输入为1010   单位1mA
	u8 canbuf3[]={0x2F,0x10,0x64,0x03,0x08,0x00,0x00,0x00};//设置电机的极对数8
	u8 canbuf4[]={0x2B,0x10,0x64,0x05,0x73,0x00,0x00,0x00};//设置电机绕组热时间常数 11.5s     输入为115    单位100ms
	u8 canbuf5[]={0x23,0x10,0x22,0x01,0x00,0x08,0x00,0x00};//设置编码器脉冲数2048
	u8 canbuf6[]={0x23,0x10,0x22,0x02,0x02,0x00,0x00,0x00};//设置主从位置编码器,主编码器，辅未知。
	u8 canbuf7[]={0x2B,0xF6,0x60,0x01,0x14,0x06,0x00,0x00};//设置电流环Kp  三环的PID参数的范围都在0-32767
	u8 canbuf8[]={0x2B,0xF6,0x60,0x02,0x6D,0x01,0x00,0x00};//设置电流环Ki
	u8 canbuf9[]={0x2B,0xF9,0x60,0x01,0x16,0x04,0x00,0x00};//设置速度环Kp
	u8 canbuf10[]={0x2B,0xF9,0x60,0x02,0x76,0x00,0x00,0x00};//设置速度环Ki
	u8 canbuf11[]={0x2B,0xFB,0x60,0x01,0xB2,0x00,0x00,0x00};//设置位置环Kp
	u8 canbuf12[]={0x2B,0xFB,0x60,0x02,0x7E,0x01,0x00,0x00};//设置位置环Ki
	u8 canbuf13[]={0x2B,0xFB,0x60,0x03,0x98,0x01,0x00,0x00};//设置位置环Kd
	
	u8 canbuf14[]={0x2B,0x40,0x60,0x00,0xFF,0x00,0x00,0x00};//清除错误标识,如果不存在故障，清楚故障条件，0xFF保证第7位为1，不太清楚具体怎么得来。
	u8 canbuf15[]={0x82,0x01};															//重置通信   cob_id+cs指令+node_id   这里的cob_id好像是0x000，如果这样的话，需要重写write代码
	u8 canbuf16[]={0x2B,0x40,0x60,0x00,0x06,0x00,0x00,0x00};//关闭通信，刷新电源，禁用驱动功能
	u8 canbuf17[]={0x01,0x01};															// 启动远程节点 
	
	u8 canbuf20[]={0x2F,0x60,0x60,0x00,0xFE,0x00,0x00,0x00};//设置操作模式V,operation mode为-2，补码为0xFE
	u8 canbuf21[]={0x2B,0x7F,0x60,0x00,0x72,0x0B,0x00,0x00};//最大速度2930
	u8 canbuf22[]={0x2B,0xC5,0x60,0x00,0x07,0xD0,0x00,0x00};//最大加速度2000
	u8 canbuf23[]={0x2B,0x40,0x60,0x00,0x06,0x00,0x00,0x00};//关闭电机
	u8 canbuf24[]={0x2B,0x40,0x60,0x00,0x0F,0x00,0x00,0x00};//打开、使能装置
	u8 canbuf25[]={0x23,0x6B,0x20,0x00,0xF4,0x01,0x00,0x00};//设置目标速度500rpm
	u8 canbuf26[]={0x2B,0x40,0x60,0x00,0x0F,0x00,0x00,0x00};//打开、使能装置
	u8 canbuf27[]={0x23,0x6B,0x20,0x00,0x00,0x00,0x00,0x00};//设置目标速度0rpm 
	u8 canbuf28[]={0x40,0x28,0x20,0x00,0x00,0x00,0x00,0x00};//读取速度值0x606C，速度平均值0x2028
	
	u8 canbuf30[]={0x2F,0x60,0x60,0x00,0xFD,0x00,0x00,0x00};//设置操作模式C，operation mode为-3，补码为0xFD
	u8 canbuf31[]={0x2B,0x10,0x64,0x01,0xF2,0x03,0x00,0x00};//设置电机额定电流最大1.01A   输入为1010   单位1mA
	u8 canbuf32[]={0x23,0x10,0x64,0x04,0x72,0x0B,0x00,0x00};//最大电机速度2930rpm
	u8 canbuf33[]={0x2B,0x10,0x64,0x05,0x73,0x00,0x00,0x00};//设置电机绕组热时间常数 11.5s     输入为115    单位100ms
	u8 canbuf34[]={0x2B,0x40,0x60,0x00,0x06,0x00,0x00,0x00};//关闭电机
	u8 canbuf35[]={0x2B,0x40,0x60,0x00,0x0F,0x00,0x00,0x00};//打开、使能装置
	u8 canbuf36[]={0x2B,0x30,0x20,0x00,0x64,0x00,0x00,0x00};//设置目标电流100mA 
	u8 canbuf37[]={0x2B,0x40,0x60,0x00,0x0F,0x00,0x00,0x00};//打开、使能装置
	u8 canbuf38[]={0x2B,0x30,0x20,0x00,0x00,0x00,0x00,0x00};//设置目标电流0mA 
  u8 canbuf39[]={0x40,0x78,0x60,0x00,0x00,0x00,0x00,0x00};//读取电流值0x6078，电流平均值0x2027
	
	u8 canbuf40[]={0x2F,0x60,0x60,0x00,0xFF,0x00,0x00,0x00};//设置操作模式P，operation mode为-1，补码为0xFF
	u8 canbuf41[]={0x23,0x65,0x60,0x00,0x20,0x4e,0x00,0x00};//设置最大跟踪误差20000qc(默认值)   一圈为2048*4qc  可以理解为2000个脉冲信号，
	u8 canbuf42[]={0x23,0x7D,0x60,0x01,0x00,0x00,0x00,0x80};//最小位置-2147483648(默认值)
	u8 canbuf43[]={0x23,0x7D,0x60,0x02,0xFF,0xFF,0xFF,0x7F};//最大位置2147483647(默认值)
	u8 canbuf44[]={0x2B,0x7F,0x60,0x00,0x72,0x0B,0x00,0x00};//最大电机速度2930rpm
	u8 canbuf45[]={0x2B,0xC5,0x60,0x00,0xFF,0xFF,0xFF,0xFF};//最大加速度4294967295
	u8 canbuf46[]={0x2B,0x40,0x60,0x00,0x06,0x00,0x00,0x00};//关闭电机
	u8 canbuf47[]={0x2B,0x40,0x60,0x00,0x0F,0x00,0x00,0x00};//打开、使能装置
	u8 canbuf48[]={0x23,0x62,0x20,0x00,0x00,0x08,0x00,0x00};//设置目标位置2048qc  1/4圈
	u8 canbuf49[]={0x2B,0x40,0x60,0x00,0x0F,0x00,0x00,0x00};//打开、使能装置
	u8 canbuf50[]={0x2B,0x40,0x60,0x00,0x00,0x00,0x00,0x00};//关闭、停止电机 
	u8 canbuf51[]={0x40,0x64,0x60,0x00,0x00,0x00,0x00,0x00};//读取位置值
	
	
	u8 key;           //保存键值
	KEY_Init();       //初始化与按键连接的硬件接口
	LED_Init();				//初始化LED端口 
	LED0=0;				  	//先点亮红灯
	u8 canbuf_V[8];//速度返回数据
	Stm32_Clock_Init(336,8,2,7);//设置时钟,168Mhz 
	delay_init(168);			//延时初始化  
	uart_init(84,115200);		//初始化串口波特率为115200  	 
	usmart_dev.init(84);		//初始化usmart

 	CAN1_Mode_Init(1,6,7,3,0);	//CAN初始化,波特率1Mbps    42/3/(6+7+1)=1
	
	CAN1_Send_Msg(canbuf0,8);//设置can比特率为1MHz
	
	CAN1_Send_Msg(canbuf14,8);//清除错误
	 
	
	
	
//	CAN1_Send_Msg(canbuf20,8);//设置操作模式V
//	CAN1_Send_Msg(canbuf21,8);
//	CAN1_Send_Msg(canbuf22,8);
//	CAN1_Send_Msg(canbuf23,8);//关闭电机

//	CAN1_Send_Msg(canbuf24,8);//打开、使能电机
//	
//	CAN1_Send_Msg(canbuf25,8);//设置目标速度500rpm
//	delay_ms(20);
	
	
	
//		CAN1_Send_Msg(canbuf30,8);//设置操作模式C
//	
//	CAN1_Send_Msg(canbuf34,8);//关闭电机

//	CAN1_Send_Msg(canbuf35,8);//打开、使能电机
//	
//	CAN1_Send_Msg(canbuf36,8);//设置目标电流100mA 



//	 delay_ms(20);
//	CAN1_Send_Msg(canbuf40,8);//设置操作模式P
//	delay_ms(20);
//	CAN1_Send_Msg(canbuf41,8);//设置最大跟踪误差20000qc(默认值)，可不设置
//	delay_ms(20);
//	CAN1_Send_Msg(canbuf42,8);//最小位置-2147483648(默认值)，可不设置
//	delay_ms(20);
//	CAN1_Send_Msg(canbuf43,8);//最大位置2147483647(默认值)，可不设置
//	delay_ms(20);
//	CAN1_Send_Msg(canbuf44,8);//最大电机速度2930rpm
//	delay_ms(20);
//	CAN1_Send_Msg(canbuf45,8);//最大加速度4294967295
//	delay_ms(20);
//	CAN1_Send_Msg(canbuf46,8);//关闭电机
//	delay_ms(20);
//	CAN1_Send_Msg(canbuf47,8);//打开、使能电机
//	delay_ms(20);
//	CAN1_Send_Msg(canbuf48,8);//设置目标位置2048qc  1/4圈
	while(1)
	{
		
		key=KEY_Scan(0);		//得到键值
	  if(key)
		{						   
			switch(key)
			{	
				//控制电机停止、失能
				case WKUP_PRES:	
					CAN1_Send_Msg(canbuf23,8);
					break;
				
				//控制速度模式
				case KEY0_PRES:	
					CAN1_Send_Msg(canbuf20,8);//设置操作模式V
					CAN1_Send_Msg(canbuf24,8);//打开、使能电机
					delay_ms(20);
					CAN1_Send_Msg(canbuf25,8);//设置目标速度500rpm
					break;
				
				//控制位置模式	慎用，还没弄清楚机制 
				case KEY1_PRES:	
					CAN1_Send_Msg(canbuf40,8);//设置操作模式P
					CAN1_Send_Msg(canbuf24,8);//打开、使能电机
					delay_ms(20);
					CAN1_Send_Msg(canbuf48,8);//设置目标位置2048qc  1/4圈
					break;
				
				//控制电流模式 
				case KEY2_PRES:	
					CAN1_Send_Msg(canbuf30,8);//设置操作模式C
					CAN1_Send_Msg(canbuf24,8);//打开、使能电机
					delay_ms(20);
					CAN1_Send_Msg(canbuf36,8);//设置目标电流100mA 
					break;
			}
		}else delay_ms(1); 
		
				
//串口读取
		CAN1_Send_Msg(canbuf39,8);//读取电流值

		CAN1_Receive_Msg(canbuf_C);
	 
		currentValue=(canbuf_C[5]<<8)+canbuf_C[4];
		
		if(currentValue>2000)
		{
			currentValue=currentValue-65536;
		}
	
		printf("%d\r\n",currentValue);
	
		delay_ms(10);
	}

//  delay_ms(500);
	
	
//	
//	while(1)
//		
//	{
//	CAN1_Send_Msg(canbuf39,8);//读取电流值

//	CAN1_Receive_Msg(canbuf_C);
//	 
//	currentValue=(canbuf_C[5]<<8)+canbuf_C[4];
//		
//		if(currentValue>2000)
//		{
//			currentValue=currentValue-65536;
//		}
//	
//	printf("%d\r\n",currentValue);
//	
//	delay_ms(100);
//		
//	}
	

		
		
	
		
		
}

















